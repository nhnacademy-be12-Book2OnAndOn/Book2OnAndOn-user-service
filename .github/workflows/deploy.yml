#name: CI/CD for User Service
#
#on:
#  push:
#    branches: [ "dev", "master" ]
#  workflow_dispatch:
#
#permissions:
#  contents: read
#  packages: write
#
#jobs:
#  deploy:
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@v3
#
#      - name: Set up JDK 21
#        uses: actions/setup-java@v3
#        with:
#          java-version: '21'
#          distribution: 'temurin'
#          cache: 'maven'
#
#      - name: Cache SonarQube packages
#        uses: actions/cache@v3
#        with:
#          path: ~/.sonar/cache
#          key: ${{ runner.os }}-sonar
#          restore-keys: ${{ runner.os }}-sonar
#
#      - name: Build and Analyze with SonarQube
#        env:
#          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#          SONAR_HOST_URL: ${{ secrets.SONARQUBE_HOST_URL }}
#        run: |
#          chmod +x mvnw
#          ./mvnw clean verify sonar:sonar \
#            -Dsonar.projectKey=Book2onandon-user-service \
#            -Dsonar.projectName="Book2onandon-user-service" \
#            -Dsonar.host.url=$SONAR_HOST_URL \
#            -Dsonar.token=$SONAR_TOKEN \
#            -Dspring.cloud.config.enabled=false \
#
#      - name: Build with Maven
#        run: |
#          chmod +x mvnw
#          ./mvnw clean package -DskipTests
#
#      - name: Login to GitHub Container Registry
#        uses: docker/login-action@v2
#        with:
#          registry: ghcr.io
#          username: ${{ github.actor }}
#          password: ${{ secrets.GITHUB_TOKEN }}
#
#      - name: Build and Push Docker Image
#        uses: docker/build-push-action@v4
#        with:
#          context: .
#          file: ./Dockerfile
#          platforms: linux/amd64
#          push: true
#          tags: ghcr.io/nhnacademy-be12-book2onandon/user-service:v1
#
#
#      - name: Deploy via SSH
#        uses: appleboy/ssh-action@master
#        with:
#          host: ${{ secrets.SERVER_HOST }}
#          username: ${{ secrets.SERVER_USERNAME }}
#          password: ${{ secrets.SERVER_PASSWORD }}
#          port: ${{ secrets.SERVER_PORT }}
#          script: |
#            cd /home/backend/be12-team2
#
#            SERVICE_NAME="USER-SERVICE"
#            EUREKA_URL="http://admin:admin1234@localhost:10437/eureka"
#
#            docker compose pull user-1 user-2
#
#            # [1] user-1 배포
#            INSTANCE_ID_1="$SERVICE_NAME:user-1"
#            curl -X PUT "$EUREKA_URL/apps/$SERVICE_NAME/$INSTANCE_ID_1/status?value=OUT_OF_SERVICE" || true
#            sleep 30
#            docker compose up -d user-1
#            sleep 40
#            curl -X PUT "$EUREKA_URL/apps/$SERVICE_NAME/$INSTANCE_ID_1/status?value=UP" || true
#
#            # [2] user-2 배포
#            INSTANCE_ID_2="$SERVICE_NAME:user-2"
#            curl -X PUT "$EUREKA_URL/apps/$SERVICE_NAME/$INSTANCE_ID_2/status?value=OUT_OF_SERVICE" || true
#            sleep 30
#            docker compose up -d user-2
#            sleep 40
#            curl -X PUT "$EUREKA_URL/apps/$SERVICE_NAME/$INSTANCE_ID_2/status?value=UP" || true
#
#            docker image prune -f

name: CI/CD for User Service

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache SonarQube packages
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Build and Analyze with SonarQube
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONARQUBE_HOST_URL }}
        run: |
          chmod +x mvnw
          ./mvnw clean verify sonar:sonar \
            -Dsonar.projectKey=Book2onandon-user-service \
            -Dsonar.projectName="Book2onandon-user-service" \
            -Dsonar.host.url=$SONAR_HOST_URL \
            -Dsonar.token=$SONAR_TOKEN \
            -Dspring.cloud.config.enabled=false \
            -Dspring.config.import="optional:file:./" \
            -DJWT_SECRET="dummy-secret-key-for-build-test-only-must-be-long" \
            -DJWT_ACCESS_VALIDITY="3600" \
            -DJWT_REFRESH_VALIDITY="86400" \
            -DENC_SECRET_KEY="12345678901234567890123456789012" \
            -DPAYCO_CLIENT_ID="dummy" \
            -DPAYCO_CLIENT_SECRET="dummy" \
            -DMAIL_USER="dummy" \
            -DMAIL_PW="dummy" \
            -DREDIS_PW="dummy" \
            -DCONFIG_USER="dummy" \
            -DCONFIG_PASS="dummy"

      - name: Build with Maven
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_ACCESS_VALIDITY: ${{ secrets.JWT_ACCESS_VALIDITY }}
          JWT_REFRESH_VALIDITY: ${{ secrets.JWT_REFRESH_VALIDITY }}
          ENC_SECRET_KEY: ${{ secrets.ENC_SECRET_KEY }}
          PAYCO_CLIENT_ID: ${{ secrets.PAYCO_CLIENT_ID }}
          PAYCO_CLIENT_SECRET: ${{ secrets.PAYCO_CLIENT_SECRET }}
          MAIL_USER: ${{ secrets.MAIL_USER }}
          MAIL_PW: ${{ secrets.MAIL_PW }}
          CONFIG_USER: ${{ secrets.CONFIG_USER }}
          CONFIG_PASS: ${{ secrets.CONFIG_PASS }}
        run: |
          chmod +x mvnw
          ./mvnw clean package -DskipTests

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: ghcr.io/nhnacademy-be12-book2onandon/user-service:v1
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_ACCESS_VALIDITY: ${{ secrets.JWT_ACCESS_VALIDITY }}
          JWT_REFRESH_VALIDITY: ${{ secrets.JWT_REFRESH_VALIDITY }}
          ENC_SECRET_KEY: ${{ secrets.ENC_SECRET_KEY }}
          PAYCO_CLIENT_ID: ${{ secrets.PAYCO_CLIENT_ID }}
          PAYCO_CLIENT_SECRET: ${{ secrets.PAYCO_CLIENT_SECRET }}
          MAIL_USER: ${{ secrets.MAIL_USER }}
          MAIL_PW: ${{ secrets.MAIL_PW }}
          REDIS_PW: ${{ secrets.REDIS_PW }}
          CONFIG_USER: ${{ secrets.CONFIG_USER }}
          CONFIG_PASS: ${{ secrets.CONFIG_PASS }}

      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            cd /home/backend/be12-team2
            
            export JWT_SECRET="${{ secrets.JWT_SECRET }}"
            export JWT_ACCESS_VALIDITY="${{ secrets.JWT_ACCESS_VALIDITY }}"
            export JWT_REFRESH_VALIDITY="${{ secrets.JWT_REFRESH_VALIDITY }}"
            export ENC_SECRET_KEY="${{ secrets.ENC_SECRET_KEY }}"
            export PAYCO_CLIENT_ID="${{ secrets.PAYCO_CLIENT_ID }}"
            export PAYCO_CLIENT_SECRET="${{ secrets.PAYCO_CLIENT_SECRET }}"
            export MAIL_USER="${{ secrets.MAIL_USER }}"
            export MAIL_PW="${{ secrets.MAIL_PW }}"
            export REDIS_PW="${{ secrets.REDIS_PW }}"
            export CONFIG_USER="${{ secrets.CONFIG_USER }}"
            export CONFIG_PASS="${{ secrets.CONFIG_PASS }}"
            
            SERVICE_NAME="USER-SERVICE"
            EUREKA_URL="http://admin:admin1234@localhost:10437/eureka"
            
            docker compose pull user-1 user-2
            
            INSTANCE_ID_1="$SERVICE_NAME:user-1"
            curl -X PUT "$EUREKA_URL/apps/$SERVICE_NAME/$INSTANCE_ID_1/status?value=OUT_OF_SERVICE" || true
            sleep 30
            docker compose up -d user-1
            sleep 40
            curl -X PUT "$EUREKA_URL/apps/$SERVICE_NAME/$INSTANCE_ID_1/status?value=UP" || true
            
            INSTANCE_ID_2="$SERVICE_NAME:user-2"
            curl -X PUT "$EUREKA_URL/apps/$SERVICE_NAME/$INSTANCE_ID_2/status?value=OUT_OF_SERVICE" || true
            sleep 30
            docker compose up -d user-2
            sleep 40
            curl -X PUT "$EUREKA_URL/apps/$SERVICE_NAME/$INSTANCE_ID_2/status?value=UP" || true
                                
            docker image prune -f